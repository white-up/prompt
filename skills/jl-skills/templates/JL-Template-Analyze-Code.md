# [项目名称] 功能分析报告 (FAR)

> **日期**: {Timestamp}
> **项目**: {项目名称}
> **涉及模块**: {模块名}

---

## 1. 背景与目标 (Context)

### 1.1 业务背景 (User Story)

> *用通俗语言描述为什么要做这个功能，解决了谁的什么问题。*
> **格式**：作为一个[角色]，我希望[做什么操作]，以便于[达到什么目的/解决什么痛点]。

**示例**：作为一名**商户财务人员**，我希望在后台**发起退款申请**，以便于**处理用户的售后请求**，无需人工线下转账。

### 1.2 核心价值

* 减少人工操作成本。
* 保证资金流向可追溯。

---

## 2. 业务流程设计 (Process Flow)

### 2.1 流程图 (Flowchart)

> *在此处插入泳道图（Swimlane Diagram）。区分：前端/用户 -> API网关 -> 业务服务 -> 数据库/第三方接口。*
> *业务人员看泳道交互，开发人员看系统边界。*

**(建议插入 mermaid 或 图片)**

### 2.2 流程步骤详解

> *对流程图的文字补充，描述“正常路径”和“关键分支”。*

1. 用户在前端点击“确认退款”。
2. 系统校验订单状态及退款金额。
3. 系统调用第三方支付渠道（微信/支付宝）接口。
4. **分支A**：如果第三方返回成功，修改本地订单状态为“退款中”。
5. **分支B**：如果第三方返回失败，直接报错提示用户。

---

## 3. 详细业务规则 (Business Rules)

> *这是开发最容易遗漏、业务最关心的部分。请列出所有“如果...那么...”的逻辑。*

### 3.1 前置校验规则 (Validation)

| 字段/对象 | 校验规则 | 错误提示文案 | 备注 |
| --- | --- | --- | --- |
| 退款金额 | 必须 > 0 且 <= 原订单剩余可退金额 | "退款金额超限" | 防资损红线 |
| 订单状态 | 必须为 `PAY_SUCCESS` 或 `PARTIAL_REFUND` | "当前订单状态不允许退款" |  |
| 时间限制 | 支付成功后 365 天内 | "订单已超过退款期限" | 渠道限制 |

### 3.2 核心处理逻辑 (Processing Logic)

> *描述输入数据如何转换为输出数据。不要写代码，写伪代码或逻辑描述。*

1. **金额计算**：计算 `本次退款金额` + `已退金额`，判断是否等于 `订单总金额`。若等于，将标记订单为“全额退款”，否则为“部分退款”。
2. **费率回退**：退款时，需按比例计算应退回的手续费（公式：`退款金额 * 原费率`）。
3. **幂等性检查**：使用 `退款单号` 作为幂等键，防止重复发起请求。

### 3.3 状态流转 (State Machine)

> *描述数据状态的变化，这对 Java 开发至关重要。*

* **涉及对象**：退款单 (RefundOrder)
* **状态流转图**：
  `INIT (初始化)` -> `PROCESSING (处理中)` -> `SUCCESS (成功)` / `FAIL (失败)`

| 起始状态 | 触发动作 | 结束状态 | 触发条件 |
| --- | --- | --- | --- |
| INIT | 调用渠道接口 | PROCESSING | 接口调用成功 |
| PROCESSING | 接收MQ回调 | SUCCESS | 渠道返回 "SUCCESS" |
| PROCESSING | 接收MQ回调 | FAIL | 渠道返回 "FAIL" |

---

## 4. 数据与接口设计 (Technical Perspective)

### 4.1 数据模型影响 (Schema Change)

> *业务人员可跳过，开发人员必看。*

* **新增/修改表**：`t_refund_order`
* **关键字段**：
* `refund_id` (主键)
* `org_order_id` (原订单号, 索引)
* `amount` (金额, DECIMAL(18,2))
* `status` (状态, TINYINT)



### 4.2 接口定义 (API Draft)

> *定义输入输出，明确契约。*

* **接口名称**：申请退款接口
* **请求方式**：POST `/api/refund/apply`
* **入参 (Request)**：
```json
{
  "orderId": "ORD2023001",
  "refundAmount": 100.00,
  "reason": "商品损坏"
}

```


* **出参 (Response)**：
```json
{
  "code": 200,
  "data": { "refundId": "REF2023999", "status": "PROCESSING" }
}

```



### 4.3 外部依赖 (Dependencies)

* **依赖服务**：需要调用 `User-Service` 查询用户权限。
* **第三方接口**：微信支付退款接口 (`https://api.mch.weixin.qq.com/...`)。
* **中间件**：RocketMQ (Topic: `REFUND_NOTIFY_TOPIC`) 用于结果异步通知。

---

## 5. 异常与边界处理 (Edge Cases)

> *不仅要考虑 Happy Path，还要考虑 Sad Path。*

| 场景 | 处理方案 | 是否需要人工介入 |
| --- | --- | --- |
| **网络超时** | 调用第三方接口超时，记录状态为 `UNKNOWN`，启动定时任务轮询查询结果。 | 否 |
| **余额不足** | 商户平台余额不足导致退款失败，直接返回失败，提示商户充值。 | 是 (商户操作) |
| **并发重复请求** | 前端防抖 + 后端分布式锁 (Key: `refund:orderId`)。 | 否 |
| **数据不一致** | 本地更新成功但发MQ失败 -> 依赖本地消息表+定时任务补偿。 | 否 |
