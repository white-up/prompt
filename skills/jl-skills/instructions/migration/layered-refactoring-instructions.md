# 分层重构指令 (Layered Refactoring Instructions)

## ⚠️ 执行规则 (EXECUTION RULES)

```
🛑 CRITICAL: 
- 每个步骤输出后 MUST STOP
- 等待用户回复后才能继续
- 一次回复只输出一个步骤的内容
- 违反此规则将导致流程失败
```

此文档指导 Agent 执行**分层代码重构（阶段 4）**。

> [!IMPORTANT]
> **目标**: 将旧代码重构为 COLA/DDD 架构的新代码。
> **原则**: 依赖倒置，领域隔离。
> **测试方法命名规范**: 参考 `jl-skills/specs/Java编码规范.md` - 方法名全英文下划线命名，中文意图使用 `@DisplayName("")` 注解。

---

## 步骤 1: 基础设施层 (Infrastructure)

**你必须输出以下内容，然后停止**:

### 1.1 生成PO和Repository

**生成内容**:
1. **PO生成**: 基于新 Schema 生成 PO (Persistent Object)
2. **Repository实现**: 实现 Repository/Gateway 接口
3. **DAO迁移**: 迁移 DAO 逻辑

### 1.2 输出基础设施层

**输出格式**:

````markdown
## 步骤 1: 基础设施层

📊 **进度**: [1/4] 分层重构
[█████░░░░░░░░░░░░░░░] 25%

| ✅ 已完成 | 🔄 进行中 | ⏳ 待完成 |
|:----------|:----------|:----------|
| | 1.基础设施层 | 2.领域层 |
| | | 3.应用与接口层 |
| | | 4.单元测试 |

---

### 生成的文件

| 文件路径 | 说明 |
|---------|------|
| `infrastructure/persistence/OrderPO.java` | 持久化对象 |
| `infrastructure/repository/OrderRepositoryImpl.java` | Repository实现 |

---

📋 **确认检查点**

基础设施层生成是否完成？

- 回复 **确认** → 进入领域层
- 回复 **调整: [内容]** → 我将调整

**请确认：** 基础设施层是否完成？
````

**🛑 STOP HERE - DO NOT OUTPUT STEP 2 UNTIL USER CONFIRMS**

⚠️ **重要**: 用户未回复"确认"前，禁止执行任何后续步骤，禁止输出步骤2的内容。

---

## 步骤 2: 领域层 (Domain)

**你必须输出以下内容，然后停止**:

### 2.1 提取业务逻辑

**提取内容**:
1. **从旧Service提取**: 提取业务逻辑
2. **充血模型**: 将逻辑下沉到 Entity/Aggregate
3. **领域服务**: 保留跨实体逻辑

### 2.2 清理依赖

**清理内容**: 移除对 Web/DB 的直接依赖

### 2.3 输出领域层

**输出格式**:

````markdown
## 步骤 2: 领域层

📊 **进度**: [2/4] 分层重构
[███████████░░░░░░░░░] 50%

| ✅ 已完成 | 🔄 进行中 | ⏳ 待完成 |
|:----------|:----------|:----------|
| 1.基础设施层 | 2.领域层 | 3.应用与接口层 |
| | | 4.单元测试 |

---

### 生成的文件

| 文件路径 | 说明 |
|---------|------|
| `domain/order/OrderAggregate.java` | 订单聚合根 |
| `domain/order/OrderDomainService.java` | 领域服务 |

---

📋 **确认检查点**

领域层提取是否完成？

- 回复 **确认** → 进入应用与接口层
- 回复 **调整: [内容]** → 我将调整

**请确认：** 领域层是否完成？
````

**🛑 STOP HERE - 必须等待用户确认后才能继续**

⚠️ **重要**: 用户未回复"确认"前，禁止执行任何后续步骤。

---

## 步骤 3: 应用与接口层 (App & Client)

### 3.1 应用层

**实现内容**:
1. **Command/Query Executor**: 实现 Executor
2. **编排领域服务**: 编排领域服务

### 3.2 接口层

**实现内容**:
1. **重写Controller**: 重写 Controller
2. **适配API契约**: 适配原 API 契约（保证对外兼容）

### 3.3 输出应用与接口层

**输出格式**:

````markdown
## 步骤 3: 应用与接口层

📊 **进度**: [3/4] 分层重构
[█████████████████░░░] 75%

| ✅ 已完成 | 🔄 进行中 | ⏳ 待完成 |
|:----------|:----------|:----------|
| 1.基础设施层 | 3.应用与接口层 | 4.单元测试 |
| 2.领域层 | | |

---

### 生成的文件

| 文件路径 | 说明 |
|---------|------|
| `app/order/OrderCreateCmdExe.java` | 命令执行器 |
| `client/order/OrderController.java` | 接口层 |

---

📋 **确认检查点**

应用与接口层是否完成？

- 回复 **确认** → 进入单元测试
- 回复 **调整: [内容]** → 我将调整

**请确认：** 应用与接口层是否完成？
````

**🛑 STOP HERE - DO NOT OUTPUT STEP 4 UNTIL USER CONFIRMS**

⚠️ **重要**: 用户未回复"确认"前，禁止执行任何后续步骤，禁止输出步骤4的内容。

---

## 步骤 4: 单元测试

**你必须输出以下内容，然后停止**:

### 4.1 TDD编写测试

**编写内容**: 为新组建编写单元测试

**⚠️ 测试方法命名规范（强制）**:
- **方法名**: 全英文，下划线命名，格式：`test_{methodName}_{condition}_{expectedResult}`
- **中文意图**: 使用 `@DisplayName("中文描述")` 注解
- **TDD 阶段标识（强制）**:
    - **🔴 Red 阶段**: 先写测试（应该失败），使用 `@DisplayName("🔴 正常流程：...")`
    - **🟢 Green 阶段**: 实现后测试通过，使用 `@DisplayName("🟢 正常流程：...")`
- **示例**:
    - 🔴 Red: `test_createOrder_validInput_shouldReturnSuccess()` + `@DisplayName("🔴 正常流程：有效输入应返回成功")`
    - 🟢 Green: `test_createOrder_validInput_shouldReturnSuccess()` + `@DisplayName("🟢 正常流程：有效输入应返回成功")`
    - 异常流程: `test_createOrder_invalidInput_shouldThrowException()` + `@DisplayName("🔴 异常流程：无效输入应抛出异常")`

### 4.2 输出单元测试

**输出格式**:

````markdown
## 步骤 4: 单元测试

📊 **进度**: [4/4] 分层重构
[████████████████████] 100%

| ✅ 已完成 | 🔄 进行中 | ⏳ 待完成 |
|:----------|:----------|:----------|
| 1.基础设施层 | 4.单元测试 | |
| 2.领域层 | | |
| 3.应用与接口层 | | |

---

### 生成的测试文件

| 文件路径 | 说明 |
|---------|------|
| `test/domain/OrderAggregateTest.java` | 聚合根测试 |
| `test/app/OrderCreateCmdExeTest.java` | 应用层测试 |

---

📋 **确认检查点**

单元测试是否完成？

- 回复 **确认** → 进入下一阶段
- 回复 **调整: [内容]** → 我将调整

**请确认：** 单元测试是否完成？
````

**🛑 STOP HERE - 必须等待用户确认后才能继续**

⚠️ **重要**: 用户未回复"确认"前，禁止执行任何后续步骤。

---

## 阶段 4 完成: 准备进入E2E验证

**触发条件**: 用户确认步骤4后

**输出格式**:

````markdown
---

## ✅ 阶段 4 完成

| ✅ 已完成 | 🔄 即将开始 |
|:----------|:------------|
| 阶段1: 范围分析 | 阶段5: E2E验证 |
| 阶段2: 黄金测试 | |
| 阶段3: 数据迁移 | |
| 阶段4: 分层重构 | |

**分层重构已完成**:
- ✅ 基础设施层已生成
- ✅ 领域层已提取
- ✅ 应用与接口层已实现
- ✅ 单元测试已编写

---

🛑 **下一步**

是否进入阶段5: E2E验证？

请回复：
- **继续** → 进入阶段5: E2E验证
- **结束** → 完成当前流程
````

**🛑 STOP HERE - 等待用户确认进入下一阶段**