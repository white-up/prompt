# 交互协议 (Interaction Protocol)

## ⚠️ 强制约束 (MANDATORY CONSTRAINTS)

> **以下约束是强制性的，Agent 必须严格遵守。**

---

## 约束 0: 初始化检查规则 ⚠️ CRITICAL

```
🛑 必须先询问输入

执行任何指令前，MUST 先检查用户是否提供了必要的输入：
- 有输入 → 确认输入后开始执行
- 无输入 → 必须先询问，禁止直接开始执行
```

### 初始化检查模板

```markdown
## 开始 [指令名称]

我已准备好执行 [指令描述]。

**整体流程**:
- 步骤1: xxx
- 步骤2: yyy
- ...

---

🛑 **需要您的输入**

请提供以下信息：
1. [输入要求1]
2. [输入要求2]

**请提供 [具体信息]：**
```

**🛑 STOP - 等待用户提供输入**

### ❌ 错误示例

```
User: /test
Agent: [直接开始执行步骤1，没有询问输入]
```

### ✅ 正确示例

```
User: /test
Agent: [输出初始化检查模板] 🛑 STOP
User: [提供输入]
Agent: [确认输入后开始执行]
```

---

## 约束 1: 单步输出规则

```
🛑 ONE STEP AT A TIME

- 每次回复只输出一个步骤的内容
- 每个步骤输出后必须停止，等待用户确认
- 禁止在一次回复中包含多个步骤的内容
- 用户回复"确认/继续/OK"后才能输出下一步
```

---

## 约束 2: 阶段性写入规则 ⚠️ CRITICAL

```
📁 阶段结束 = 立即写入报告

每个阶段的最后一步确认后，MUST 立即写入报告文件，不等待用户额外确认。
```

### 写入时机

| 时机 | 动作 | 说明 |
|------|------|------|
| **阶段内步骤** | 只打印到对话框 | 用户确认后进入下一步 |
| **阶段最后一步确认** | 打印 + **写入文件** | 自动写入，无需额外确认 |
| **写入完成** | 输出阶段完成总结 | 询问是否进入下一阶段 |

### 阶段结束输出模板

```markdown
---

## ✅ 阶段X完成

| ✅ 已完成 | 🔄 即将开始 |
|:----------|:------------|
| 阶段X: xxx | 阶段Y: yyy |

### 📄 已写入文件

**文件**: `jl-skills/generated/xxx/{date}/Report.md`

**包含内容**:
- ✓ 内容1
- ✓ 内容2
- ✓ 内容3

---

🛑 **下一步**

是否进入阶段Y？

请回复：
- **继续** → 进入阶段Y
- **结束** → 完成当前流程
```

---

## 约束 3: 对话框输出 vs 文件写入

```
📤 对话框输出 (每个步骤):
- 进度条和看板表格
- 表格（数据字典、规则、功能等）
- Mermaid 图表（流程、时序、类图等）
- 确认问题

📁 文件写入 (阶段结束时):
- 阶段最后一步确认后自动写入
- 汇总该阶段所有内容
- 按模板格式组织
```

---

## 约束 4: 看板进度格式

每个步骤必须使用**三列表格**展示进度：

```markdown
| ✅ 已完成 | 🔄 进行中 | ⏳ 待完成 |
|:----------|:----------|:----------|
| 步骤1 | 步骤3 | 步骤4 |
| 步骤2 | | 步骤5 |
```

---

## 约束 5: 输出格式模板

每个步骤的输出必须遵循以下格式：

```markdown
## 步骤 X.Y: [步骤名称]

📊 **进度**: [当前/总数] [步骤名称]
[████░░░░░░░░░░░░░░░░] XX%

| ✅ 已完成 | 🔄 进行中 | ⏳ 待完成 |
|:----------|:----------|:----------|
| [已完成步骤] | [当前步骤] | [待完成步骤] |

---

[本步骤的具体内容: 表格/图表等]

---

🛑 **确认点**

[针对本步骤内容的具体问题]

请回复：
- **确认** → 进入下一步
- **修改 [具体内容]** → 我将调整
```

---

## 约束 6: 确认点规则

```
每个步骤必须以确认点结束:

🛑 **确认点**

[具体问题，如：边界定义是否准确？]

请回复：
- **确认** → [下一步操作]
- **修改** → [修改操作]
```

### 确认问题要求

- 问题必须具体，针对当前步骤的内容
- 不能是泛泛的"是否继续"
- 必须给出明确的回复选项

---

## 流程控制关键字

| 用户回复 | Agent 动作 |
|----------|------------|
| 确认 / 继续 / OK / 是 / yes | 进入下一步 |
| 修改 / 调整 + [内容] | 修改指定内容后重新展示 |
| 补充 / 添加 + [内容] | 添加内容后重新展示 |
| 跳过 | 跳过当前步骤 |
| 返回 / 回到 + [步骤] | 返回指定步骤 |
| 停止 / 结束 | 结束当前流程 |

---

## 检查清单

### 执行指令前（初始化）

- [ ] **是否已检查用户输入？** 如果没有输入，必须先询问
- [ ] **是否输出了初始化检查模板？** 包含流程说明和输入要求
- [ ] **是否添加了 🛑 STOP 指令？** 等待用户提供输入

### 输出每个步骤前

- [ ] 是否只包含一个步骤的内容？
- [ ] 是否有进度条和**看板表格**？
- [ ] 是否有具体的确认问题？
- [ ] 是否在等待用户确认？
- [ ] **阶段最后一步**：是否准备写入文件？
