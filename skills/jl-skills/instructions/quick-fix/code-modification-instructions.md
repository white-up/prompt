# 代码修改指令 (Code Modification Instructions)

## ⚠️ 执行规则 (EXECUTION RULES)

```
🛑 CRITICAL: 
- 每个步骤输出后 MUST STOP
- 等待用户回复后才能继续
- 一次回复只输出一个步骤的内容
- 违反此规则将导致流程失败
```

此文档指导 Agent 执行快速改动流程的**阶段 3: 代码修改**。

> [!IMPORTANT]
> **目标**: 实施代码改动，让测试通过（Green 阶段）。
> **原则**: 
> - **优先新写方法，然后在调用处替换**，而不是直接修改原方法
> - 遵循 TDD 原则，最小化改动，确保测试通过
> - 保持老功能的测试基线，确保不破坏现有功能

---

## 步骤 3.1: 代码修改方案确认

**你必须输出以下内容，然后停止**:

### 3.1.1 回顾变更分析

**回顾内容**:
1. 需要修改的文件清单
2. 修改类型和内容
3. 影响范围

### 3.1.2 输出修改方案

**输出格式**:

````markdown
## 步骤 3.1: 代码修改方案

📊 **进度**: [3/6] 代码修改
[████████████░░░░░░░░] 50%

| ✅ 已完成 | 🔄 进行中 | ⏳ 待完成 |
|:----------|:----------|:----------|
| 1.需求明确与变更分析 | 3.1.代码修改方案 | 3.2.代码写入 |
| 2.单元测试补充 | | 3.3.绿灯确认 |
| | | 4.测试验证 |
| | | 5.生命周期提示 |

---

### 修改策略 ⚠️ 重要

**优先采用"新方法+替换调用"策略**:
- ✅ **新写方法**: 创建新方法实现改动后的逻辑（如 `method1New()`）
- ✅ **保留老方法**: 暂时保留原方法（如 `method1()`），确保测试基线不破坏
- ✅ **替换调用**: 在所有调用处替换为新方法
- ✅ **后续清理**: 确认无误后，可以删除老方法（可选）

**优势**:
- 降低风险，可以逐步替换调用点
- 便于回滚，如果新方法有问题可以快速切回老方法
- 保持测试基线，老方法的测试仍然有效

---

### 即将修改的文件

| 文件路径 | 修改类型 | 修改内容 | 修改原因 |
|---------|---------|---------|---------|
| `src/main/java/.../XxxService.java` | 新写方法 | 新增 `method1New()` 方法 | 实现改动后的逻辑 |
| `src/main/java/.../XxxService.java` | 替换调用 | 在调用处替换为 `method1New()` | 应用新逻辑 |
| `src/main/java/.../XxxController.java` | 新增方法 | 新增 `createXxx()` 接口 | 新增功能 |

---

### 修改说明

**文件1: XxxService.java**

**修改点1: 新写 method1New() 方法**
- **方法签名**: `public Result method1New(Param param)`
- **实现逻辑**: [描述新方法的实现逻辑]
- **与原方法的区别**: [说明改动点]

**修改点2: 替换调用处**
- **调用位置1**: `XxxController.method1()` → 调用 `method1New()` 替代 `method1()`
- **调用位置2**: `YyyService.process()` → 调用 `method1New()` 替代 `method1()`

**文件2: XxxController.java**

**修改点1: 新增 createXxx() 方法**
- **方法签名**: `public ResponseEntity<XxxDTO> createXxx(@RequestBody XxxDTO dto)`
- **实现逻辑**: [描述实现逻辑]
- **调用关系**: 调用 `XxxService.createXxx()`

---

### 实现要点

- ✅ 遵循现有代码风格
- ✅ 优先新写方法，然后在调用处替换
- ✅ 保持向后兼容（如需要）
- ✅ 添加必要的注释
- ✅ 处理异常情况
- ✅ 确保不破坏老功能的测试基线

---

📋 **确认检查点**

修改方案是否合理？

- 回复 **确认** → 立即写入修改后的代码文件
- 回复 **调整: [具体说明]** → 我将修改实现方案

**请确认：** 是否开始修改代码？
````

**🛑 STOP HERE - DO NOT OUTPUT STEP 3.2 UNTIL USER CONFIRMS**

⚠️ **重要**: 用户未回复"确认"前，禁止执行任何后续步骤，禁止输出步骤3.2的内容。

---

## 步骤 3.2: 代码写入

**你必须输出以下内容，然后停止**:

### 3.2.1 直接写入修改后的代码

**执行规则**:
- ⚠️ **重要**: 实现代码直接写入文件，**不打印到对话框**
- 只显示文件列表和修改说明
- **关键**: 优先新写方法，然后在调用处替换

**写入完成后输出**:

````markdown
### ✅ 代码修改已完成

**修改的文件**:
- `src/main/java/.../XxxService.java`
- `src/main/java/.../XxxController.java`

**修改内容**:
- ✅ 新增 `XxxService.method1New()` 方法（新逻辑）
- ✅ 在调用处替换为 `method1New()`（替换调用）
- ✅ 新增 `XxxController.createXxx()` 方法

**修改策略**:
- ✅ 采用"新方法+替换调用"策略
- ✅ 保留原方法（如需要），确保测试基线不破坏

---

🛑 **TDD 关键步骤：确认绿灯**

请执行以下操作：

1. **运行测试**
   ```bash
   mvn test
   # 或
   ./gradlew test
   ```

2. **确认测试通过**（这是预期的 🟢 绿灯状态）
   - ✅ 所有测试通过（包括老功能的测试）
   - ✅ 改动功能正常
   - ✅ 新方法逻辑正确

3. **如果测试失败**
   - 请告诉我具体的失败信息，我将修复代码
   - 如果实现逻辑需要调整，请告诉我
   - 如果是调用处替换有问题，我可以调整

---

📋 **确认检查点**

- 回复 **绿灯确认** → 测试已执行，确认通过（🟢 绿灯），进入下一阶段
- 回复 **测试失败: [具体错误信息]** → 我将修复代码
- 回复 **调整实现: [具体说明]** → 我将修改实现逻辑

**请确认：** 测试是否已执行并确认通过（🟢 绿灯）？
````

**🛑 STOP HERE - 等待用户执行测试并确认绿灯**

---

## 步骤 3.3: 处理测试失败（如需要）

### 3.3.1 处理测试失败

**触发条件**: 用户回复 `测试失败: [具体错误信息]` 或 `调整实现: [具体说明]`

**处理流程**:
1. 读取用户报告的测试失败信息或调整需求
2. 分析失败原因：
   - 语法错误
   - 逻辑错误
   - 测试用例不匹配
3. 修复代码
4. **重新写入代码文件**（覆盖原文件）
5. 输出修复说明，**再次要求用户执行测试确认绿灯**

**输出格式**:

````markdown
### ✅ 代码已修复并重新写入

**修复内容**:
- [修复点1]: [说明]
- [修复点2]: [说明]

**修改的文件**:
- `src/main/java/.../XxxService.java`

---

🛑 **请再次执行测试确认绿灯**

请执行以下操作：
1. **运行测试**
   ```bash
   mvn test
   ```

2. **确认测试通过**（🟢 绿灯）

**请确认：** 测试是否已执行并确认通过（🟢 绿灯）？
````

**🛑 STOP HERE - 等待用户再次确认绿灯**

---

## 阶段 3 完成: 准备进入测试验证

**触发条件**: 用户确认绿灯后

**输出格式**:

````markdown
---

## ✅ 阶段 3 完成

| ✅ 已完成 | 🔄 即将开始 |
|:----------|:------------|
| 阶段1: 需求明确与变更分析 | 阶段4: 测试验证 |
| 阶段2: 单元测试补充 | |
| 阶段3: 代码修改 | |

### 📄 代码修改已完成

**修改的文件**:
- `src/main/java/.../XxxService.java`
- `src/main/java/.../XxxController.java`

**测试状态**: 🟢 绿灯（测试通过）

---

🛑 **下一步**

现在进入阶段4: 测试验证，确认所有测试通过，改动正确。

是否进入测试验证阶段？

请回复：
- **继续** → 进入阶段4: 测试验证
- **结束** → 完成当前流程
````

**🛑 STOP HERE - 等待用户确认进入下一阶段**